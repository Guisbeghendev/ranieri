{% extends 'base.html' %}
{% load static %}

{% block title %}{{ gallery.name }} - Detalhes - {{ project_name }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="bg-prata1 p-6 rounded-lg shadow-md mb-8">
        <h1 class="text-4xl font-bold text-roxo1 mb-4 text-center">{{ gallery.name }}</h1>
        <p class="text-preto1 text-center mb-6">{{ gallery.description|default:"Nenhuma descrição disponível." }}</p>

        {# Data do Evento com destaque #}
        <p class="text-cinza1 text-center mb-4 text-lg font-semibold">Data do Evento: {{ gallery.event_date|date:"d/m/Y" }}</p>

        {# Informações de criação e atualização sem destaque #}
        <p class="text-cinza1 text-center text-sm">
            Criado em: {{ gallery.created_at|date:"d/m/Y H:i" }} | Última atualização: {{ gallery.updated_at|date:"d/m/Y H:i" }}
        </p>

        ---
        {# Seção de Curtidas da Galeria #}
        <div class="flex items-center justify-center mt-4">
            <span class="text-roxo1 text-lg font-semibold mr-2">
                Likes: <span id="gallery-likes-count-{{ gallery.pk }}">{{ gallery.likes.count }}</span>
            </span>

            {% if user.is_authenticated %}
                <button id="like-button-{{ gallery.pk }}"
                        class="like-button px-4 py-2 rounded-lg shadow-md transition duration-300
                                {% if user_has_liked %}bg-red-500 hover:bg-red-600 text-white{% else %}bg-roxo2 hover:bg-roxo1 text-white{% endif %}"
                        data-gallery-id="{{ gallery.pk }}"
                        data-liked="{{ user_has_liked|yesno:'true,false' }}"> {# Adicionado data-liked para o JS #}
                    {% if user_has_liked %}Descurtir{% else %}Curtir{% endif %}
                </button>
            {% else %}
                <span class="text-cinza1 text-sm">Faça <a href="{% url 'account_login' %}" class="text-roxo2 hover:underline">login</a> para curtir.</span>
            {% endif %}
        </div>
        ---

    </div>

    <div class="text-center mb-8">
        <a href="{% url 'public_galleries:public_gallery_list' %}" class="px-6 py-3 bg-roxo2 text-branco1 rounded-lg shadow-md hover:bg-roxo1 transition duration-300 w-full sm:w-auto text-center inline-flex items-center justify-center">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
            <span class="hidden sm:inline">&larr; Voltar para as Galerias Públicas</span>
            <span class="inline sm:hidden">&larr; Voltar</span>
        </a>
    </div>

    {% if images %}
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 image-grid">
            {% for image in images %}
                <a class="group block relative overflow-hidden rounded-lg cursor-pointer transform hover:scale-105 transition-transform duration-300 ease-in-out"
                   data-image-url="{% if image.image_file_watermarked %}{{ image.image_file_watermarked.url }}{% elif image.image_file_original %}{{ image.image_file_original.url }}{% else %}https://placehold.co/800x600/e0e0e0/555555?text=Imagem+Nao+Disponivel{% endif %}"
                   data-index="{{ forloop.counter0 }}"
                   onclick="openModal(this)">

                    <img class="w-full h-40 object-cover bg-prata1 rounded-lg border border-gray-200"
                         src="{% if image.image_file_thumb %}{{ image.image_file_thumb.url }}{% elif image.image_file_original %}{{ image.image_file_original.url }}{% else %}https://placehold.co/400x300/e0e0e0/555555?text=Sem+Imagem{% endif %}"
                         alt="{{ gallery.name }} - Imagem {{ forloop.counter }}"
                         loading="lazy">

                    <div class="absolute inset-0 bg-black bg-opacity-40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                        <div class="flex items-center gap-x-1 py-1 px-2 bg-white border border-gray-200 text-gray-800 rounded-lg">
                            <svg class="shrink-0 size-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                            <span class="text-sm font-medium">Ver Imagem</span>
                        </div>
                    </div>
                </a>
            {% endfor %}
        </div>

    {% else %}
        <p class="text-preto1 text-center py-8 text-lg bg-prata1 rounded-lg shadow-sm">
            <span class="font-bold">Ops!</span> Nenhuma imagem disponível para esta galeria ainda.
            <br>Por favor, verifique novamente mais tarde ou entre em contato com o fotógrafo.
        </p>
    {% endif %}
</div>

<div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-50 hidden p-4">
    <div class="relative max-w-4xl max-h-[90vh] mx-auto bg-white rounded-lg shadow-xl overflow-hidden">
        <button class="absolute top-3 right-3 text-white bg-gray-800 rounded-full p-2 text-2xl font-bold z-10 hover:bg-gray-600 transition-colors duration-200" onclick="closeModal()" aria-label="Fechar Imagem">
            &times;
        </button>

        <button id="prevBtn" class="absolute left-3 top-1/2 transform -translate-y-1/2 bg-gray-800 text-white p-3 rounded-full text-2xl z-10 hover:bg-gray-600 transition-colors duration-200" onclick="showPreviousImage()" aria-label="Imagem Anterior">
            &#10094;
        </button>

        <button id="nextBtn" class="absolute right-3 top-1/2 transform -translate-y-1/2 bg-gray-800 text-white p-3 rounded-full text-2xl z-10 hover:bg-gray-600 transition-colors duration-200" onclick="showNextImage()" aria-label="Próxima Imagem">
            &#10095;
        </button>

        <img id="modalImage" src="" alt="Imagem em destaque da galeria" class="max-w-full max-h-[80vh] object-contain mx-auto block rounded-t-lg">

        <div id="modalCaption" class="bg-gray-800 text-white text-center py-2 px-4 text-sm hidden">
            Legenda da Imagem
        </div>
    </div>
</div>

<button id="backToTopBtn" class="fixed bottom-8 right-8 bg-roxo2 text-branco1 p-3 rounded-full shadow-lg hover:bg-roxo1 transition-colors duration-300 hidden" aria-label="Voltar ao Topo">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>
</button>

{% endblock %}

{% block extra_js %}
    {# REMOVIDO: Incluir jQuery aqui. Agora o script usa Fetch API. #}

    <script>
        let currentImageIndex = 0;
        let imageUrls = []; // Array para armazenar as URLs de todas as imagens

        document.addEventListener('DOMContentLoaded', function() {
            // Popula o array imageUrls e adiciona a classe 'image-grid' para facilitar a seleção
            const imageLinks = document.querySelectorAll('.image-grid a');
            imageLinks.forEach(link => {
                imageUrls.push(link.getAttribute('data-image-url'));
            });

            // Esconde a legenda se estiver vazia
            const modalCaption = document.getElementById('modalCaption');
            if (modalCaption && modalCaption.innerText.trim() === '') {
                modalCaption.classList.add('hidden');
            }

            // --- Lógica de Curtidas (JS) - AGORA USANDO FETCH API ---
            const likeButton = document.getElementById('like-button-{{ gallery.pk }}');
            const likesCountSpan = document.getElementById('gallery-likes-count-{{ gallery.pk }}');
            const galleryId = likeButton.dataset.galleryId;
            let userHasLiked = likeButton.dataset.liked === 'true'; // Pega o estado inicial do like

            // Função para obter o token CSRF do cookie
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            if (likeButton) { // Garante que o botão existe antes de adicionar o listener
                console.log("Botão de like encontrado e script de like carregado."); // DEBUG: Adicionado para verificar carregamento
                likeButton.addEventListener('click', function() {
                    console.log("Botão de like clicado!"); // DEBUG: Adicionado para verificar clique

                    // Verifica se o usuário está logado
                    if (!{{ user.is_authenticated|lower }}) {
                        alert('Você precisa estar logado para curtir uma galeria.');
                        window.location.href = "{% url 'account_login' %}"; // Use a URL de login do app de contas
                        return;
                    }

                    const csrftoken = getCookie('csrftoken');

                    fetch(`{% url 'galleries_pub:like_public_gallery' pk=gallery.pk %}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken,
                        },
                        body: JSON.stringify({}) // Corpo vazio para POST simples
                    })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(err => {
                                throw new Error(err.message || 'Erro desconhecido do servidor.');
                            }).catch(() => {
                                throw new Error(`Erro do servidor: ${response.status} ${response.statusText}`);
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        // A view like_public_gallery já retorna 'liked' e 'likes_count'
                        userHasLiked = data.liked;
                        likesCountSpan.textContent = data.likes_count;

                        // Atualiza as classes e o texto do botão
                        if (userHasLiked) {
                            likeButton.classList.remove('bg-roxo2', 'hover:bg-roxo1');
                            likeButton.classList.add('bg-red-500', 'hover:bg-red-600');
                            likeButton.textContent = 'Descurtir';
                        } else {
                            likeButton.classList.remove('bg-red-500', 'hover:bg-red-600');
                            likeButton.classList.add('bg-roxo2', 'hover:bg-roxo1');
                            likeButton.textContent = 'Curtir';
                        }
                        console.log(data.message);
                    })
                    .catch(error => {
                        console.error("Erro ao curtir/descurtir:", error);
                        alert("Ocorreu um erro ao processar o like. Por favor, tente novamente. Detalhes: " + error.message);
                    });
                });
            } else {
                console.error("Botão de like com ID 'like-button-{{ gallery.pk }}' não encontrado."); // DEBUG: Adicionado para depuração
            }
        });

        // Funções do modal de imagens
        function openModal(clickedElement) {
            currentImageIndex = parseInt(clickedElement.dataset.index);
            updateModalImage();
            document.getElementById('imageModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function updateModalImage() {
            const modalImage = document.getElementById('modalImage');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            modalImage.src = imageUrls[currentImageIndex];

            prevBtn.style.display = (currentImageIndex === 0) ? 'none' : 'block';
            nextBtn.style.display = (currentImageIndex === imageUrls.length - 1) ? 'none' : 'block';
        }

        function showNextImage() {
            if (currentImageIndex < imageUrls.length - 1) {
                currentImageIndex++;
                updateModalImage();
            }
        }

        function showPreviousImage() {
            if (currentImageIndex > 0) {
                currentImageIndex--;
                updateModalImage();
            }
        }

        function closeModal() {
            document.getElementById('imageModal').classList.add('hidden');
            document.getElementById('modalImage').src = '';
            document.body.style.overflow = '';
        }

        document.getElementById('imageModal').addEventListener('click', function(event) {
            if (event.target === this || event.target.tagName === 'IMG') {
                closeModal();
            }
        });

        document.addEventListener('keydown', function(event) {
            if (document.getElementById('imageModal').classList.contains('hidden')) {
                return;
            }
            if (event.key === 'Escape') {
                closeModal();
            } else if (event.key === 'ArrowRight') {
                showNextImage();
            } else if (event.key === 'ArrowLeft') {
                showPreviousImage();
            }
        });

        // Lógica para o botão "Voltar ao Topo"
        const backToTopBtn = document.getElementById('backToTopBtn');

        window.addEventListener('scroll', () => {
            if (window.scrollY > 300) {
                backToTopBtn.classList.remove('hidden');
            } else {
                backToTopBtn.classList.add('hidden');
            }
        });

        backToTopBtn.addEventListener('click', () => {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });

        window.addEventListener('resize', () => {
            // Nada específico para redimensionar aqui, pois o CSS já lida com max-width/height
        });
    </script>
{% endblock %}
